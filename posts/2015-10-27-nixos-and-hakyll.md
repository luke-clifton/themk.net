---
title: NixOS, Pandoc and Hakyll
---

## Why?

I like [NixOS](http://nixos.org/). It is a fantastic system. I also
like writing stuff in a simple format like markdown, because it guarantees
some form of consistency. [Pandoc](http://pandoc.org/) is my choice of
markdown to HTML converter. [Hakyll](http://jaspervdj.be/hakyll/) is just
a convenient way of gluing it all together.

## My setup

Since Hakyll sites are generated by Haskell programs, I thought I would
just use the Haskell ecosystem in NixOS to build my program, and then override
the `installPhase` with something that executes the program and copies the
site files to the correct location.

#### themk.net.nix
``` nix
{ mkDerivation, base, hakyll, stdenv }:
mkDerivation {
  pname = "themk-net";
  version = "0.1.0.0";
  src = ./.;
  isLibrary = false;
  isExecutable = true;
  executableHaskellDepends = [ base hakyll ];
  license = stdenv.lib.licenses.bsd3;

  # Override the installPhase to execute the
  # program, and copy the results to $out
  installPhase = ''
    mkdir -p $out
    ./dist/build/site/site build
    cp -a _site $out
  '';
}
```

#### default.nix
``` nix
{ nixpkgs ? import <nixpkgs> {}, compiler ? "ghc7102" }:
nixpkgs.pkgs.haskell.packages.${compiler}.callPackage ./themk.net.nix { }
```

#### shell.nix
``` nix
{ nixpkgs ? import <nixpkgs> {}, compiler ? "ghc7102" }:
(import ./default.nix { inherit nixpkgs compiler; }).env
```

My `site.hs` file is fairly similar to the default one generated
by `hakyll-init`. I removed some sections that I didn't want, and
added one for my historic notes. These also required a new context
because I didn't have a date for them.

#### site.hs
``` haskell
-------------------------------------------
{-# LANGUAGE OverloadedStrings #-}
import           Data.Monoid (mappend)
import           Hakyll

-------------------------------------------

main :: IO ()
main = hakyll $ do
    match "images/*" $ do
        route   idRoute
        compile copyFileCompiler


    match "css/*" $ do
        route   idRoute
        compile compressCssCompiler


    match "notes/historic/*" $ do
        route $ setExtension "html"
        compile $ pandocCompiler
            >>= loadAndApplyTemplate "templates/historic-note.html" historicCtx
            >>= loadAndApplyTemplate "templates/default.html"       historicCtx
            >>= relativizeUrls


    match "posts/*" $ do
        route $ setExtension "html"
        compile $ pandocCompiler
            >>= loadAndApplyTemplate "templates/post.html"    postCtx
            >>= loadAndApplyTemplate "templates/default.html" postCtx
            >>= relativizeUrls


    match "index.html" $ do
        route idRoute
        compile $ do
            posts <- recentFirst =<< loadAll "posts/*"
            historic <- loadAll "notes/historic/*"
            let indexCtx =
                    listField "posts" postCtx (return posts) `mappend`
                    listField "historic" historicCtx (return historic) `mappend`
                    constField "title" "Home"                `mappend`
                    defaultContext

            getResourceBody
                >>= applyAsTemplate indexCtx
                >>= loadAndApplyTemplate "templates/default.html" indexCtx
                >>= relativizeUrls

    match "templates/*" $ compile templateCompiler


-------------------------------------------
postCtx :: Context String
postCtx =
    dateField "date" "%B %e, %Y" `mappend`
    defaultContext

historicCtx :: Context String
historicCtx =
    defaultContext
```
