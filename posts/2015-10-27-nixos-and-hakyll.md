---
title: NixOS, Pandoc and Hakyll
---

## My setup

Since Hakyll sites are generated by Haskell programs, I thought I would
just use the Haskell ecosystem in NixOS to build my program, and then override
the `installPhase` with something that executes the program and copies the
site files to the correct location. Following the instructions in the
[NixOS User Guide](https://nixos.org/nixpkgs/manual/#users-guide-to-the-haskell-infrastructure),
I the main `nix` file with `cabal2nix` and manually add the `default.nix`
and `shell.nix` files. I then make a small change to the `themk.net.nix`
file generated by `cabal2nix`.

#### themk.net.nix
``` nix
{ mkDerivation, base, hakyll, stdenv }:
mkDerivation {
  pname = "themk-net";
  version = "0.1.0.0";
  src = ./.;
  isLibrary = false;
  isExecutable = true;
  executableHaskellDepends = [ base hakyll ];
  license = stdenv.lib.licenses.bsd3;

  # ------- Change is here -------------------
  # Override the installPhase to execute the
  # program, and copy the results to $out
  installPhase = ''
    mkdir -p $out
    ./dist/build/site/site build
    cp -a _site $out
  '';
}
```

My `site.hs` file is fairly similar to the default one generated
by `hakyll-init`. I removed some sections that I didn't want, and
added one for my historic notes. These also required a new context
because I didn't have a date for them.

We can now use this package from within `configuration.nix` to set
up `httpd` to point to our new derivation.

```nix
let site = pkgs.callPackage ./themk.net {}
in {
  # ...
 
  services.httpd = {
      adminAddr = "webmaster@themk.net";
      enable = true;
      hostName = "themk.net";
      documentRoot = "${site}";
    };

  # ...
}
```
